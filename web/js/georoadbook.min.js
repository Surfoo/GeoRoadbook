!function(){function ParseFile(file){var reader=new FileReader,fileinfo=[{name:file.name,size:file.size}];reader.onload=function(e){return window.DOMParser?(parser=new DOMParser,doc=parser.parseFromString(e.target.result,"text/xml")):(doc=new ActiveXObject("Microsoft.XMLDOM"),doc.async="false",doc.loadXML(e.target.result)),doc=parser.parseFromString(e.target.result,"application/xml"),doc&&"gpx"==doc.documentElement.tagName?(content_gpx=e.target.result,void 0):(content_gpx=null,$("#error").html('<p>"'+fileinfo[0].name+'" in an invalid file.<p>').show().delay(3e3).fadeOut(),!1)},reader.readAsText(file,"UTF-8")}$("#spoilers4gpx").click(function(event){event.preventDefault(),window.open(this.href)});var content_gpx=null;$("#hint").change(function(){$("#hint").is(":checked")?$("#hint_options").show():$("#hint_options").hide()}),$("#sort").change(function(){$("#sort").is(":checked")?$("#sort_options").show():$("#sort_options").hide()}),$(".option-help").tooltip({placement:"right"}),window.File&&window.FileList&&window.FileReader?$("#gpx").change(function(e){for(var f,files=e.target.files||e.dataTransfer.files,i=0;f=files[i];i++){if(f.size>8388608)return $("#error").html('<p>"'+f.name+'" is too big, 8Mo Max.<p>').show(),!1;ParseFile(f)}}):$("#error").html("<p>Your browser doesn't support some features. Please, upgrade it.<br /> If you are using Internet Explorer 9, you must install the version 10 at least.</p>").show(),$('input[type="submit"]').click(function(){if(!content_gpx)return $("#error").html("<p>GPX file is missing.</p>").show().delay(3e3).fadeOut(),!1;var btn=$(this);return btn.button("loading"),$.ajax({url:"upload.php",type:"POST",data:{gpx:content_gpx,locale:$("#locale").attr("selected","selected").val(),toc:!!$('input[name="toc"]:checked').val(),note:!!$('input[name="note"]:checked').val(),short_desc:!!$('input[name="short_desc"]:checked').val(),long_desc:!!$('input[name="long_desc"]:checked').val(),hint:!!$('input[name="hint"]:checked').val(),hint_encrypted:!!parseInt($('input[name="hint_encrypted"]:checked').val()),waypoints:!!$('input[name="waypoints"]:checked').val(),spoilers:!!$('input[name="spoilers"]:checked').val(),logs:!!$('input[name="logs"]:checked').val(),sort_by:$('input[name="sort_by"]:checked').val(),pagebreak:!!$('input[name="pagebreak"]:checked').val(),images:!!$('input[name="images"]:checked').val()},success:function(data){return data&&""!==data&&"object"==typeof data?data&&!data.success?($("#error").html("<p>"+data.message+"</p>").show(),btn.button("reset"),void 0):($(location).attr("href",data.redirect),void 0):void 0},failure:function(){}}),!1}),$('a[data-dismiss="fileupload"]').click(function(){content_gpx=null}),null!==document.getElementById("editable")&&$().ready(function(){tinymce.init({selector:"#editable",language:language,height:"297mm",plugins:["advlist autolink link image lists charmap hr anchor pagebreak","searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime nonbreaking","table contextmenu paste textcolor"],content_css:"../design/roadbook.css",menubar:!1,toolbar1:"undo redo | formatselect fontselect fontsizeselect | forecolor backcolor | bold italic underline strikethrough",toolbar2:"alignleft aligncenter alignright alignjustify |Â bullist numlist outdent indent | link image hr table subscript superscript charmap pagebreak | code fullscreen",browser_spellcheck:!0,pagebreak_separator:'<p class="pagebreak"><!-- pagebreak --></p>',width:"210mm",height:"297mm",schema:"html4",apply_source_formatting:!0,setup:function(editor){editor.on("change",function(){$("#btn_save").removeClass("disabled").prop("disabled",!1)})}})}),$("#btn_delete").button().click(function(){if($(this).hasClass("disabled"))return!1;if(!confirm("Are you sure to delete your roadbook?"))return!1;var ed=tinyMCE.get("editable");ed.setProgressState(1),$.ajax({url:"/delete.php",type:"POST",datatype:"json",data:{id:roadbook_id},success:function(data){ed.setProgressState(0),data&&""!==data&&"object"==typeof data&&data&&data.success&&$(location).attr("href","../?deleted")},failure:function(){ed.setProgressState(0)}})}),$("#ui_export").on("show",function(){return $("#btn_export").hasClass("disabled")?!1:($.getJSON("/roadbook/"+roadbook_id+".json",function(data){$.each(data,function(key,val){$("#"+key).is("input[type=checkbox]")?($("#"+key).attr("value",val),val&&($("#"+key).prop("checked",!0),$("#"+key.substr(0,6)+"_text").prop("disabled",!0))):$("#"+key).is("select")?($("#"+key).val(val),$("#"+key+" option[value="+val+"]").attr("selected","selected")):$("#"+key).is("input")&&$("#"+key).attr("value",val)})}),void 0)}),$("#btn_save").click(function(){return $(this).hasClass("disabled")?!1:(saveHtml(),void 0)}),$("#apply").click(function(){_ajax(!1)}),$("#export").click(function(){saveHtml(),$("#ui_export").modal("hide"),_ajax(!0)}),$("#header_pagination").click(function(){$("#header_text").prop("disabled",!$("#header_text").prop("disabled"))}),$("#footer_pagination").click(function(){$("#footer_text").prop("disabled",!$("#footer_text").prop("disabled"))});var saveHtml=function(){var ed=tinyMCE.get("editable");ed.setProgressState(1),$.ajax({url:"/save.php",type:"POST",datatype:"json",data:{id:roadbook_id,content:ed.getContent()},beforeSend:function(){$("#btn_save").button("loading")},success:function(data){data&&data.success&&($("#btn_save").attr("title",data.last_modification),ed.startContent=ed.getContent(),ed.isNotDirty=!0)},complete:function(){$("#btn_save").addClass("disabled").prop("disabled",!0).data("loading-text","Save").button("loading")},failure:function(){}}),ed.setProgressState(0)},_ajax=function(real_export){var ed=tinyMCE.get("editable");ed.setProgressState(1),$("#btn_save").addClass("disabled"),$("#btn_export").addClass("disabled"),$("#btn_download_title").addClass("disabled"),$("#btn_download").addClass("disabled"),$("#btn_delete").addClass("disabled"),$.ajax({url:"/export.php",type:"POST",data:{real_export:real_export,id:roadbook_id,"page-size":document.forms[0].page_size.value,orientation:document.forms[0].orientation.value,"margin-left":document.forms[0].margin_left.value,"margin-right":document.forms[0].margin_right.value,"margin-top":document.forms[0].margin_top.value,"margin-bottom":document.forms[0].margin_bottom.value,"header-align":document.forms[0].header_align.value,"header-text":document.forms[0].header_text.value,"header-pagination":!!$('input[name="header_pagination"]:checked').val(),"footer-align":document.forms[0].footer_align.value,"footer-text":document.forms[0].footer_text.value,"footer-pagination":!!$('input[name="footer_pagination"]:checked').val()},success:function(data){return ed.setProgressState(0),$("#btn_save").removeClass("disabled"),$("#btn_export").removeClass("disabled"),$("#btn_download_title").removeClass("disabled"),$("#btn_download").removeClass("disabled"),$("#btn_delete").removeClass("disabled"),real_export?data&&""!==data?"object"!=typeof data?(alert("Conversion failed :-(\nMessage:\n"+data),void 0):(data&&data.success?(ed.setProgressState(0),$("#dl_pdf").show(),$("#download_link").html(data.link+" ("+data.size+"Mo)"),$("#ui_exported").modal("show")):alert("Conversion failed :-(\nMessage:\n"+data.error),void 0):(alert("Conversion failed :-("),void 0):void 0},failure:function(){ed.setProgressState(0),$("#btn_save").removeClass("disabled"),$("#btn_export").removeClass("disabled"),$("#btn_download_title").removeClass("disabled"),$("#btn_download").removeClass("disabled"),$("#btn_delete").removeClass("disabled"),real_export&&alert("Error in exportation.")}})}}();